<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <style>
      ol {
        overflow-y: auto;
        min-height: 200px;
        max-height: 250px;
        width: 50%;
        background-color: black;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>{title}</h1>
    <h2>Current serving from "{cwd}"</h2>
    <p>Hi from Rust</p>
    <div id="app">
      <ol id="messages"></ol>
    </div>
    <script>
      const messages = document.getElementById('messages');
      const app = document.getElementById('app');

      function handleCommand(cmd) {
        const [key] = Object.keys(cmd);
        switch (key) {
          case 'CreateElement': {
            const args = cmd[key];
            console.log('create-element', args);

            const el = document.createElement(args.el);
            if (args.attrs) {
              Object.entries(args.attrs).forEach(([attr, value]) => {
                if (el.hasAttribute(attr)) {
                  el.setAttribute(attr, value);
                } else el[attr] = value;
              });
            }
            const parent = args.parent ? document.getElementById(parent) : app;
            parent.appendChild(el);
            console.log({
              created: el,
              parent,
            });
            return true;
          }
          case 'RemoveElement': {
            console.log('remove-element');
            const args = cmd[key];
            const toRemove = document.getElementById(args.id);
            if (toRemove) {
              toRemove.parentNode.removeChild(toRemove);
            }
            return true;
          }
        }
        return false;
      }

      function print(...args) {
        console.log(...args);
        const pre = document.createElement('pre');
        pre.textContent = args.join('');
        messages.appendChild(pre);
        messages.scrollTop = messages.scrollHeight;
      }

      print('tryConnect');
      const ws = new WebSocket('ws://localhost:3012');
      ws.onmessage = ({ data }) => {
        if (data.startsWith('json')) {
          const json = data.substr(4);
          const cmd = JSON.parse(json);

          if (handleCommand(cmd)) {
            return;
          }
        }
        print(`server responded: "${data.replace(/\"/g, '\\"')}"`);
      };
      ws.onopen = () => {
        print('ws connection open');
        ws.send('hi from client!');
        print('message sent!');
      };
      ws.onclose = () => {
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      };

      const label = document.createElement('label');
      label.for = 'edit';
      label.innerText = 'search for stuff';
      const edit = document.createElement('input');
      edit.id = 'edit';
      edit.type = 'text';
      edit.oninput = (e) => ws.send(e.target.value);

      app.insertBefore(edit, messages);
      app.insertBefore(label, edit);
    </script>
  </body>
</html>
